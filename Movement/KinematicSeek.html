<!DOCTYPE html>
<head>	
	<script type="text/javascript" src="http://cdn.craftycomponents.com/crafty-release.js"></script>
</head>
<body>
	<script type="text/javascript">
		Crafty.init(400, 400);
		
		Crafty.sprite(1, "../images/facing.jpg", {
		    face: [0, 0]
		});
		Crafty.sprite(1, "../images/facing-red.jpg", {
		    face_red: [0, 0]
		});
		
		Crafty.c("Velocity",{
			_velocity:{x:0,y:0,rotation:0},
		    _time:1,
		    init:function(){

		        var viewport = Crafty.viewport.rect();
		        this.bind("EnterFrame", function () {

		            this.attr({x : (viewport._w + this.x + this._velocity.x * this._time) % viewport._w,
		                       y : (viewport._h + this.y + this._velocity.y * this._time) % viewport._h,
		                       rotation : (this.rotation + this._velocity.rotation * this._time) % 360});
		
		        });
		        return this;
		    },
		    velocity:function(x,y,rotation){
			    this._velocity = {x:x,y:y,rotation:rotation}
		        return this;
		    },
			steering: function(x, y, rotation) {
				this._velocity = {x: this._velocity.x+x * this._time,
					              y: this._velocity.y+y * this._time,
					              rotation: this._velocity.rotation+rotation * this._time};
		        return this;
		    }
		});
		
		Crafty.c("Seek", {
			_target: null,
		    init: function() {
		        var viewport = Crafty.viewport.rect();
		        this.bind("EnterFrame", function() {
                    if(this._target){
						var vx = this._target.x - this.x;
						var vy = this._target.y - this.y;

						// should normalize
						
						var length = Math.sqrt((vx * vx) + (vy * vy));
						vx = vx / length;
						vy = vy / length;

						// switch to max speed

						vx *= 0.05;
						vy *= 0.05;

						// orient in appropriate direction
						var vr = this.getNewOrientation(this.rotation,vx,vy);
						vr *= 0.0001;

						// output steering
						
						this.steering(vx,vy,vr);

	                }

		        });
		        return this;
		    },
		    seek: function(target) {
		        this._target = target;
		        return this;
		    },
		    getNewOrientation: function(currentOrientation, vx, vy) {

		        // Make sure we have a velocity
		        if (vx > 0 && vy > 0)

		        // Calculate orientation using an arc tangent of
		        // the velocity components.
		          return Math.atan2(-vx, vy);

		        // Otherwise use the current orientation
		        else 
		          return currentOrientation;
		    }
		});

		Crafty.c("RandomPosition", {
			init: function() {
				this.attr({ x: Crafty.math.randomInt(50,350), y: Crafty.math.randomInt(50,350), rotation: Crafty.math.randomInt(0,359)});
			}
		});

		var target = Crafty.e("2D, DOM, Twoway, RandomPosition, Color, Velocity, face_red").twoway(3).attr({w: 50, h: 50}).origin('center').velocity(.3,.4,1);
		var character = Crafty.e("2D, DOM, Twoway, RandomPosition, Color, Velocity, face, Seek").twoway(3).attr({w: 50, h: 50}).origin('center').velocity(0,0,0).seek(target);
		
		
	</script>
</body>
</html>