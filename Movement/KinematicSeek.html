<!DOCTYPE html>
<head>	
	<script type="text/javascript" src="http://cdn.craftycomponents.com/crafty-release.js"></script>
</head>
<body>
	<script type="text/javascript">
		Crafty.init(400, 400);
		
		Crafty.sprite(1, "../images/facing-trans.png", {
		    face: [0, 0]
		});
		Crafty.sprite(1, "../images/facing-red-trans.png", {
		    face_red: [0, 0]
		});
		
		Crafty.c("Velocity",{
			_velocity:{x:0,y:0,rotation:0},
		    _time:1,
		    init:function(){

		        var viewport = Crafty.viewport.rect();
		        this.bind("EnterFrame", function () {

		            this.attr({x : (viewport._w + this.x + this._velocity.x * this._time) % viewport._w,
		                       y : (viewport._h + this.y + this._velocity.y * this._time) % viewport._h});
		
					// orient in appropriate direction
					this.rotation = this.getNewOrientation(this.rotation,this._velocity.x,this._velocity.y);
		
		        });
		        return this;
		    },
		    velocity:function(x,y,rotation){
			    this._velocity = {x:x,y:y,rotation:rotation}
		        return this;
		    },
			steering: function(x, y, rotation) {
				this._velocity = {x: x,
					              y: y};
		        return this;
		    },
		    getNewOrientation: function(currentOrientation, vx, vy) {
                var newOrientation = currentOrientation;
		        // Make sure we have a velocity (if not just return current orientation)
		        if (vx != 0 && vy != 0){
		          // Calculate orientation using an arc tangent of
		          // the velocity components. 
		          newOrientation = (Math.atan2(vy,vx) * 180.0/ Math.PI) + 90.0;
		        }
		        return newOrientation;
		    }
		});
		
		Crafty.c("Seek", {
			_target: null,
		    init: function() {
		        var viewport = Crafty.viewport.rect();
		        this.bind("EnterFrame", function() {
                    if(this._target){
						var vx = this._target.x - this.x;
						var vy = this._target.y - this.y;

						// normalize
						
						var length = Math.sqrt((vx * vx) + (vy * vy));
						vx = vx / length;
						vy = vy / length;

						// switch to max speed

						vx *= 2;
						vy *= 2;



						// output steering
						
						this.steering(vx,vy,0);

	                }

		        });
		        return this;
		    },
		    seek: function(target) {
		        this._target = target;
		        return this;
		    }
		});

		Crafty.c("RandomPosition", {
			init: function() {
				this.attr({ x: Crafty.math.randomInt(50,350), y: Crafty.math.randomInt(50,350), rotation: 0});
			}
		});

		var target = Crafty.e("2D, DOM, Twoway, RandomPosition, Color, Velocity, face_red").twoway(3).attr({w: 31, h: 42}).origin(15,35).velocity(2.2,2.2,0);
		var character = Crafty.e("2D, DOM, Twoway, RandomPosition, Color, Velocity, face, Seek").twoway(3).attr({w: 31, h: 42}).origin(15,30).velocity(0,0,0).seek(target);
		
		
	</script>
</body>
</html>